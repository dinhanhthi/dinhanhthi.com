---
alwaysApply: true
---

# dinhanhthi.com - Cursor Rules

## Tech Stack

- **Framework**: Next.js 15+ (App Router)
- **Styling**: Tailwind CSS v4
- **CMS**: Notion (using custom Notion renderer integrated into the project)
- **Cache**: Upstash Redis (for Notion API response caching)
- **Email**: Resend (for error notifications)
- **Language**: TypeScript
- **Package Manager**: pnpm
- **Deployment**: Vercel

## Development Commands

```bash
# Development server (port 3004)
pnpm run dev

# Build
pnpm run build

# Production server (port 3004)
pnpm start

# Linting
pnpm run lint

# Format code
pnpm run prettier

# Clean build artifacts
pnpm run clean

# Full rebuild
pnpm run clean-build

# Reinstall dependencies
pnpm run reinstall

# Redis cache management (requires Redis setup)
pnpm run warm-cache        # Populate Redis cache with fresh data
pnpm run clear-cache --all # Clear all Redis cache
```

## Architecture Overview

### Notion Renderer Components

This project uses a **custom Notion renderer** integrated directly into the codebase (previously a git submodule, now fully migrated):

- **Location**:
  - Components: `src/components/notion/` - React components for rendering Notion blocks
  - Icons: `src/app/icons/` - Custom icon components
  - Utilities: `src/lib/notion/` - Notion-specific helper functions, hooks, context, and database utilities
  - Shared utilities: `src/lib/` - General utilities (config, fetcher, helpers, fonts, utils)
  - Styles: `src/components/notion/styles/` - SCSS styles for Notion rendering
- **Import pattern**:
  - Notion utilities: `@/src/lib/notion/*`
  - General utilities: `@/src/lib/*` (e.g., `@/src/lib/config`, `@/src/lib/utils`)
  - Components: `@/src/app/components/*` or `@/src/app/icons/*`
- **Architecture principle**: All utilities live in `src/lib/`, NOT in `src/app/lib/`

### Project Structure

```
src/
├── app/                      # Next.js App Router
│   ├── (single-page)/       # Route group for static pages (about, tools, reading, etc.)
│   ├── api/                 # API routes (og, search-notion)
│   ├── components/          # App-specific React components
│   ├── hooks/               # Custom React hooks
│   ├── icons/               # Icon components
│   ├── note/[slug]/        # Dynamic note pages
│   ├── tag/[[...slug]]/    # Tag pages with optional catch-all
│   └── templates/           # Page templates
├── components/              # Shared components
│   └── notion/             # Notion renderer components
│       ├── post-types/     # Post card component variants
│       └── styles/         # Notion rendering styles
├── lib/                     # All utilities and business logic
│   ├── notion/             # Notion-specific utilities
│   │   ├── context.tsx     # Notion context provider
│   │   ├── db.ts          # Notion database utilities (with Redis cache)
│   │   ├── helpers.ts     # Notion helper functions
│   │   ├── hooks.ts       # Notion custom hooks
│   │   ├── interface.ts   # TypeScript interfaces
│   │   ├── renderer.tsx   # Main renderer component
│   │   └── ...            # Other Notion utilities
│   ├── config.ts           # Site-wide constants and settings
│   ├── fetcher.ts          # Data fetching utilities (with Redis cache)
│   ├── redis-cache.ts      # Redis caching layer (Upstash)
│   ├── helpers.ts          # General helper functions
│   ├── fonts.ts            # Font configurations
│   └── utils.ts            # General utilities (cn, etc.)
├── data/                    # Static data files (menus, skills, topics, etc.)
└── fontello/                # Custom icon fonts
```

### Data Flow & Notion Integration

This site uses **Notion as a headless CMS**. Content is fetched from multiple Notion databases:

- **Posts DB**: Main content (notes/blog posts) with properties like tags, slug, published status, language
- **Tools DB**: Curated tools collection
- **Reading DB**: Books and reading list
- **Topics DB**: Topic taxonomy with icons and metadata

Environment variables (see `example.env.local`) define:

- Notion API credentials (`NOTION_TOKEN`)
- Database IDs and property keys (e.g., `NEXT_PUBLIC_ID_TAGS`, `NEXT_PUBLIC_ID_SLUG`)
- Feature flags (`ENV_MODE`, `NEXT_PUBLIC_ENV_MODE`)
- Redis credentials (`UPSTASH_REDIS_REST_URL`, `UPSTASH_REDIS_REST_TOKEN`) - Optional but recommended
- Resend credentials (`RESEND_API_KEY`, `ADMIN_EMAIL`) - Optional but recommended for error monitoring

### Redis Cache Layer

This project uses **Upstash Redis** for caching Notion API responses:

- **Location**: `src/lib/redis-cache.ts`
- **Strategy**: Stale-while-revalidate with fallback to cached data on errors
- **Benefits**:
  - Users always see content (even when Notion API fails)
  - Faster page loads from cached data
  - Reduced Notion API calls
  - Error logging for developers (hidden from users)
- **Setup**: See [docs/REDIS.md](./docs/REDIS.md)
- **Note**: Redis is optional. Without configuration, the site works normally but without caching.

### Error Notifications (Resend)

This project uses **Resend** for sending email notifications when critical errors occur:

- **Location**: `src/lib/send-error-email.ts`
- **Triggers**: Notion API failures, cache errors, network timeouts
- **Features**:
  - Rate limiting (1 email per 5 minutes per error type)
  - Detailed error context (function name, params, stack trace)
  - Graceful degradation (errors logged but never shown to users)
- **Setup**: See [docs/RESEND_QUICK_START.md](./docs/RESEND_QUICK_START.md) or [docs/ERROR_NOTIFICATIONS.md](./docs/ERROR_NOTIFICATIONS.md)
- **Note**: Resend is optional. Without configuration, errors are only logged to console.

**Cached Functions**:
- All functions in `src/lib/fetcher.ts`: `getPosts()`, `getTopics()`, `getUnofficialPosts()`, etc.
- Block fetching in `src/lib/notion/db.ts`: `getBlocks()`

**Cache TTL Strategy** (Refresh-Ahead Pattern):
- Uses **two TTL values**: `softTTL` (refresh threshold) + `hardTTL` (deletion time)
- **softTTL**: When to refresh cache in background (user gets instant response)
- **hardTTL**: When Redis deletes cache (safety net, typically 30 days)
- Configuration defined in `src/lib/config.ts` → `redisCacheTTL` constant
- In normal operation, hardTTL is **never reached** (cache refreshes every softTTL)

### TypeScript Configuration

- Path alias: `@/*` (root - maps to project root)
- Strict mode enabled with unused variable checks
- Custom type declarations in `src/interface.d.ts` and `src/lib/notion/react-copy-to-clipboard.d.ts`

## Environment Setup

1. Copy `example.env.local` to `.env.local`
2. Configure Notion credentials and database IDs
3. Set `ENV_MODE=dev` for local development
4. (Optional but recommended) Configure Redis credentials:
   - Sign up at [Upstash Console](https://console.upstash.com/)
   - Create a Redis database
   - Add `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN` to `.env.local`
   - See [docs/REDIS.md](./docs/REDIS.md) for detailed setup
5. (Optional but recommended) Configure Resend for error notifications:
   - Sign up at [Resend](https://resend.com/)
   - Create an API key
   - Add `RESEND_API_KEY` and `ADMIN_EMAIL` to `.env.local`
   - See [docs/RESEND_QUICK_START.md](./docs/RESEND_QUICK_START.md) for detailed setup

## Code Style

- ESLint configured with Next.js, React, TypeScript, Tailwind, and Unicorn plugins
- Prettier with import sorting and Tailwind class ordering
- Max line length: 100 characters
- Warnings for unused imports and variables

## Deployment Notes

- Deployed on Vercel with pnpm (automatically detected via `packageManager` field)
- pnpm configuration in `.npmrc` handles peer dependencies and hoisting
- Build script warnings for native packages (sharp, @tailwindcss/oxide) are expected and non-breaking
- Static page generation timeout: 180 seconds
- Preview deployments have `X-Robots-Tag: noindex` header
- Sitemap auto-generated with `next-sitemap` in postbuild step
- **Redis Cache (Production)**:
  - Add `UPSTASH_REDIS_REST_URL` and `UPSTASH_REDIS_REST_TOKEN` to Vercel Environment Variables
  - Recommended to use separate Redis database for production
  - See [docs/REDIS.md](./docs/REDIS.md) for production setup details
- **Error Notifications (Production)**:
  - Add `RESEND_API_KEY` and `ADMIN_EMAIL` to Vercel Environment Variables
  - Free tier: 3,000 emails/month (sufficient with rate limiting)
  - See [docs/ERROR_NOTIFICATIONS.md](./docs/ERROR_NOTIFICATIONS.md) for production setup

## Important Constraints

- **Git operations**: NEVER use git commands in this project - user handles all git operations manually
- **Answer in Vietnamese** but keep the code and terminology in English
- **Package Manager**: Always use `pnpm`, never `npm` or `yarn`
- **Architecture**: All utilities in `src/lib/`, NOT `src/app/lib/`
- **Imports**: Use `@/src/lib/*` for utilities, `@/src/app/components/*` for components

## Redis Cache Quick Reference

**Setup** (Optional but Recommended):
1. Sign up at [Upstash Console](https://console.upstash.com/) (free tier available)
2. Create a Redis database
3. Add credentials to `.env.local`:
   ```bash
   UPSTASH_REDIS_REST_URL="https://your-url.upstash.io"
   UPSTASH_REDIS_REST_TOKEN="your-token"
   ```
4. For production: Add same credentials to Vercel Environment Variables

**Cache Management**:
```bash
pnpm run warm-cache        # Populate Redis cache
pnpm run clear-cache --all # Clear all cache
```

**Benefits**:
- ✅ Users always see content (even when Notion API fails)
- ✅ Faster page loads (cached data)
- ✅ Reduced API calls and costs
- ✅ Error logging for monitoring (errors hidden from users)

**Note**: Redis is optional. Without it, the site works normally but without caching.

## Previous Versions

- Version 1-5: Jekyll/Gatsby/11ty implementations
- Version 6: Used separated [notion-x](https://github.com/dinhanhthi/notion-x) repo
- Version 7 (current): Fully integrated custom Notion renderer with Redis cache

## Auto-Update Rules (For AI)

**IMPORTANT**: When you detect changes in the project that affect the documentation, you MUST proactively update this file (`.cursor/rules/dat-com-rules.mdc`) and `CLAUDE.md`.

### Triggers for Auto-Update

Update rules files when you detect:

1. **Architecture Changes**:
   - New directories in `src/` (e.g., new `src/lib/something/`)
   - Changes in import patterns or path aliases
   - Restructuring of components, utilities, or data flow
   - Migration from one pattern to another (e.g., submodule → integrated code)

2. **Tech Stack Changes**:
   - Framework upgrades (Next.js, React versions)
   - New major dependencies (Tailwind, Redis, CMS, etc.)
   - Package manager changes
   - Build tool modifications

3. **Development Workflow Changes**:
   - New npm/pnpm scripts in `package.json`
   - New environment variables in `example.env.local`
   - Changes in build/dev commands
   - New cache management strategies

4. **Feature Additions**:
   - New integrations (APIs, databases, services)
   - New data sources or databases
   - New caching layers or optimization strategies
   - New deployment configurations

5. **Code Style/Convention Changes**:
   - ESLint/Prettier config updates
   - New coding patterns or best practices
   - TypeScript configuration changes
   - Import/export conventions

### How to Update

When updating rules files:

1. **Identify the change**: Clearly note what has changed in the project
2. **Update both files**: Keep `CLAUDE.md` and `.cursor/rules/dat-com-rules.mdc` in sync
3. **Be specific**: Update exact sections (Tech Stack, Commands, Architecture, etc.)
4. **Preserve structure**: Maintain the existing format and organization
5. **Inform user**: Explicitly mention that you've updated the rules files and what changed

### Example Update Flow

```
1. Detect: New `src/lib/database/` directory added with PostgreSQL integration
2. Update:
   - Tech Stack section → Add "Database: PostgreSQL"
   - Architecture section → Document new database utilities
   - Environment Setup → Add PostgreSQL credentials
3. Inform: "I've updated CLAUDE.md and dat-com-rules.mdc to reflect the new PostgreSQL integration"
```

**Note**: This is a living document. Keep it accurate and up-to-date to ensure AI assistance remains effective.
